const tg = window.Telegram?.WebApp;
if (tg) {
  tg.expand();
  tg.setHeaderColor('#0b0f14');
  tg.setBackgroundColor('#0b0f14');
}

const intro = document.getElementById('stage-intro');
const shuffle = document.getElementById('stage-shuffle');
const pick = document.getElementById('stage-pick');
const reveal = document.getElementById('stage-reveal');

const btnShuffle = document.getElementById('btn-shuffle');
const btnReset = document.getElementById('btn-reset');
const btnSend = document.getElementById('btn-send');

const shuffleBar = document.getElementById('shuffle-bar');
const shuffleCaption = document.getElementById('shuffle-caption');
const cardsWrap = document.getElementById('cards');
const revealArea = document.getElementById('reveal-area');
const workBar = document.getElementById('work-bar');
const workCaption = document.getElementById('work-caption');

const TAROT = [
  'Ð”ÑƒÑ€ÐµÐ½ÑŒ','ÐœÐ°Ð³','Ð–Ñ€Ð¸Ñ†Ñ','Ð†Ð¼Ð¿ÐµÑ€Ð°Ñ‚Ñ€Ð¸Ñ†Ñ','Ð†Ð¼Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€','Ð†Ñ”Ñ€Ð¾Ñ„Ð°Ð½Ñ‚',
  'ÐšÐ¾Ñ…Ð°Ð½Ñ†Ñ–','ÐšÐ¾Ð»Ñ–ÑÐ½Ð¸Ñ†Ñ','Ð¡Ð¸Ð»Ð°','Ð’Ñ–Ð´Ð»ÑŽÐ´Ð½Ð¸Ðº','ÐšÐ¾Ð»ÐµÑÐ¾ Ð¤Ð¾Ñ€Ñ‚ÑƒÐ½Ð¸','Ð¡Ð¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ñ–ÑÑ‚ÑŒ',
  'ÐŸÐ¾Ð²Ñ–ÑˆÐµÐ½Ð¸Ð¹','Ð¡Ð¼ÐµÑ€Ñ‚ÑŒ','ÐŸÐ¾Ð¼Ñ–Ñ€ÐºÐ¾Ð²Ð°Ð½Ñ–ÑÑ‚ÑŒ','Ð”Ð¸ÑÐ²Ð¾Ð»','Ð’ÐµÐ¶Ð°','Ð—Ñ–Ñ€ÐºÐ°','ÐœÑ–ÑÑÑ†ÑŒ','Ð¡Ð¾Ð½Ñ†Ðµ','Ð¡ÑƒÐ´','Ð¡Ð²Ñ–Ñ‚'
];

const state = { candidates: [], chosen: null };

function randCard() {
  const name = TAROT[Math.floor(Math.random() * TAROT.length)];
  const upright = Math.random() > 0.4;
  return { name, upright };
}

function el(tag, cls){ const n=document.createElement(tag); if(cls) n.className=cls; return n; }

function setStage(s){
  for(const n of [intro, shuffle, pick, reveal]) n.classList.add('hidden');
  s.classList.remove('hidden'); s.classList.add('fade');
}

function cardNode(faceText, pos){
  const c = el('div','card');
  const inner = el('div','card-inner');
  const back = el('div','face back'); back.textContent = 'ðŸ‚ ';
  const front = el('div','face front');
  const h = el('h3'); h.textContent = faceText; front.appendChild(h);
  const p = el('div','pos'); p.textContent = pos; front.appendChild(p);
  c.appendChild(inner); inner.append(back, front); return c;
}

function shuffleFlow(){
  setStage(shuffle);
  shuffleBar.style.width = '0%';
  const steps = ['ÐŸÐµÑ€ÐµÐ¼Ñ–ÑˆÑƒÑŽ ÐºÐ¾Ð»Ð¾Ð´Ñƒâ€¦','Ð—Ð±Ð¸Ñ€Ð°ÑŽ ÐµÐ½ÐµÑ€Ð³Ñ–ÑŽâ€¦','Ð’Ð¸Ñ€Ñ–Ð²Ð½ÑŽÑŽ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¸â€¦','ÐšÐ¾Ð»Ð¾Ð´Ð° Ð½Ð°Ð¿Ð¾Ð²Ð½ÑŽÑ”Ñ‚ÑŒÑÑâ€¦'];
  let i=0, p=0;
  const id = setInterval(()=>{
    p = Math.min(100, p + 8 + Math.random()*6);
    shuffleBar.style.width = p+'%';
    if(i < steps.length && p > (i+1)*(100/steps.length)){
      shuffleCaption.textContent = steps[i++];
    }
    if(p>=100){ clearInterval(id); setTimeout(()=>startPick(), 300); }
  }, 260);
}

function startPick(){
  state.candidates = [randCard(), randCard(), randCard()];
  setStage(pick);
  cardsWrap.innerHTML='';
  for(let i=0;i<3;i++){
    const n = cardNode('â€”','â€”');
    n.dataset.index = i;
    n.addEventListener('click', ()=>choose(i, n));
    cardsWrap.appendChild(n);
  }
}

function choose(index, node){
  const c = state.candidates[index];
  state.chosen = { index, ...c };
  setStage(reveal);

  revealArea.innerHTML='';
  const label = c.name;
  const pos = c.upright ? 'â¬†ï¸ ÐŸÑ€ÑÐ¼Ð°' : 'â¬‡ï¸ ÐŸÐµÑ€ÐµÐ²ÐµÑ€Ð½ÑƒÑ‚Ð°';
  const card = cardNode(label, pos);
  revealArea.appendChild(card);
  setTimeout(()=>card.classList.add('flip'), 60);

  workBar.style.width='0%';
  const phrases = [
    'âœ¨ Ð—Ð²ÐµÑ€Ñ‚Ð°ÑŽÑÑ Ð´Ð¾ Ð²Ð¸Ñ‰Ð¸Ñ… ÑÐ¸Ð»â€¦',
    'ðŸ”® ÐÐ½Ð°Ð»Ñ–Ð·ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ð¸â€¦',
    'ðŸ“œ Ð¡ÐºÐ»Ð°Ð´Ð°ÑŽ Ñ‚Ð»ÑƒÐ¼Ð°Ñ‡ÐµÐ½Ð½Ñâ€¦',
    'ðŸ’« Ð’Ñ–Ð´Ñ‡ÑƒÐ²Ð°ÑŽ ÐµÐ½ÐµÑ€Ð³Ñ–ÑŽ Ð´Ð¾Ð»Ñ–â€¦'
  ];
  let s=0, step=0;
  const id = setInterval(()=>{
    step+=1; const pct = Math.min(100, step*22);
    workBar.style.width = pct+'%';
    if(s<phrases.length){ workCaption.textContent = phrases[s++]; }
    if(pct>=100){ clearInterval(id); }
  }, 420);
}

function sendToBot(){
  const payload = {
    action: 'pick_card',
    chosen: state.chosen,
    candidates: state.candidates
  };
  console.log("ðŸ“¤ ÐÐ°Ð´ÑÐ¸Ð»Ð°ÑŽ Ð² Ð±Ð¾Ñ‚Ð°:", payload);
  if(tg && tg.sendData){
    tg.sendData(JSON.stringify(payload));
    tg.close();
  } else {
    alert("âš ï¸ ÐÐµ Ð² Telegram â€” Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼.\n" + JSON.stringify(payload, null, 2));
  }
}

btnShuffle.addEventListener('click', shuffleFlow);
btnReset.addEventListener('click', ()=>setStage(intro));
btnSend.addEventListener('click', sendToBot);
